\documentclass[11pt]{article}
\usepackage[margin=1in]{geometry}
\usepackage{amsmath,amsthm,amssymb,bbm}
\usepackage{float}
\usepackage{hyperref}
\usepackage{booktabs}
\usepackage{placeins}
\usepackage{graphicx}
\usepackage[
backend=biber,
style=bwl-FU,
sorting=ynt
]{biblatex}
\addbibresource{../../main.bib}

\DeclareMathOperator*{\argmax}{arg\,max}
\DeclareMathOperator*{\argmin}{arg\,min}

\title{Matching Model}
\author{Jos√© I. Velarde Morales}

\begin{document}
\maketitle

\section{Model for Incorporating Farmer Surveys} \label{limited-data}
  \subsection{Background}
    I recently spoke to a researcher from the Institute Research Institute for Climate and Society (IRR) at Columbia University. They have implemented index insurance programs in several countries across Africa and are currently implementing programs in several other countries. They developed a more participatory approach to designing index insurance. Their approach involves conducting interviews with farmers to determine which were the worst years for the harvest. This participatory approach was motivated by several features of the context. First, household level loss data is usually not available in the countries this team works in. This makes it much harder to develop a model that directly predicts loss. Second, incorporating farmers into the design process makes it easier to ensure that the product being developed will be useful for the farmers. This increases the likelihood the farmers will buy the product. This approach has been used by the IRI team in several countries with success, however, the team expressed concerns that the approach they use to incorporate the farmer surveys is non-systematic. 

    The team is mainly focused on designing multi-phase insurance for single villages. In multi-phase insurance, the growing season is split up into multiple phases and there is a different payout function for each phase. The insurance designers must choose the exact dates to include in each phase, how to allocate the insured amount across phases (e.g. if there are two phases it could be 50/50 or 30/70), and what the payout rate should be in each phase. When designing the insurance, they can see in which past years their proposed insurance would have issued a payout, and they try to match as many of the bad years the farmers identified. The main constraints they are worried about is payout frequency and price. They want the insurance to payout approximately once every 5 years, but getting the frequency right becomes increasingly challenging as there are more phases.  

  \subsection{Model}
  In this model, we are maximizing the number of bad years as identified by farmers in which the insurance would have issued a payout. In other words, if year $y$ was identified as farmers as a particularly bad year, we want the insurance we design to have issued out a payout in that year.  

    \paragraph{Data}
      \begin{itemize}
        \item $\theta \in \mathbb{R}^{D \times Y}$: $\theta$ is remote sensing data where $D$ is the number of dekads (10 day intervals), and $Y$ is the number of years we have data for. In practice, $\theta$ is often rainfall, $D=36$ because there are 365 days in the year, and $Y\in [20,40]$.
        \item $b \in \{ 0,1\}^Y$: $b$ is a binary vector indicating bad years as identified by farmers. $b_i = 1$ if farmers identified year $i$ as a bad year. 
        \item $T$: number of phases in insurance contract. 
        \item $B$: budget 
        \item $\underline{f}, \overline{f}$: minimum and maximum desired frequency for insurance
      \end{itemize}

    \paragraph{Decision Variables}
      \begin{itemize}
        \item $z \in \{ 0,1\}^Y$: $z$ is a binary variable indicating in which years the insurance would have issued a payout. $z_i = 1$ if the insurance would have issued out a payout in year $i$. 
        \item $A \in \{ 0,1\}^{T \times D}$: $Y$ is a binary matrix indicating which dekads are included in which phase. $y_{td} = 1$ if dekad $d$ is included in phase $t$. 
        \item $w_t$ is the weight assigned to phase $t$. We have that $\sum_t w_t = 1$ 
        \item $\gamma \in \mathbb{R}^{T \times Y}$: $\gamma^y_t$ is the sum of rainfall in phase $t$ of year $y$. 
        \item $\alpha \in \{ 0,1\}^{T \times D}$: $\alpha$ is a helper variable to ensure that the phases are non overlapping.
        \item $D \in \{ 0,1\}^{T \times D-1}$: this is a helper variable to ensure that phases are continuous. 
      \end{itemize}
    
    \begin{align}
      \max_{A,D,z,\gamma,a,b,\alpha} &\sum_{y=1}^{Y} b_y z_y \\
        \text{s.t.   } Mz_y &\geq \sum_{t=1}^{T} \max \left \{a_t \gamma_t^y + b_t,0 \right \}\\
        \underline{f} &\leq \frac{1}{Y} \sum_{y=1}^{Y} z_y \leq \overline{f}\\
        \sum_{y=1}^{Y} & \sum_{t=1}^{T} \max \left \{a_t \gamma_t + b_t,0 \right \} + c_{\kappa}K \leq B\\
        K &\leq CVaR_{1-\epsilon_P} \left ( \sum_{t=1}^{T} \max \left \{ a_t \gamma_t + b_t,0 \right \} \right ) - \mathbb{E} \left [ \min \left \{ a_t \gamma^t +b_t, w_t \right \} \right ]\\
        \sum_{t=1}^{T} A_{t,d} &\leq 1, \forall d \\ 
        D_{t,d} &= |A_{t,d+1}-A_{t,d}|, \quad \forall t, \quad d=1,...,D-1\\
        \sum_{d=1}^{D-1} D_{t,d} &\leq 2, \forall t \\
        A_{t,1} &+ A_{t,D} \leq 1, \forall t \\
        \gamma_t^y &= \sum_{d=1}^{D} \theta_{yd}Y_{td}, \forall t,d \\
        \alpha^t_1 &= A_{t,1}, \forall t \\
        \alpha^t_d &\leq A_{t,d} + \alpha^t_{d-1}, \forall t, \quad d=2,...,D\\
        A_{t,d} &\leq \alpha^{t-1}_d - A_{t-1,d}, \quad t=2,...,T, \forall d\\
        \sum_{t=1}^T w_t &= 1\\
        z_i, & \alpha^t_i, A_{ij} \in \{ 0,1\}
    \end{align}

    Constraint (2) ensures that $z_i = 1$ if a payout was issued in year $i$. Constraint (3) is the payout frequency constraint. Constraints (4) and (5) are the budget constraints. Constraint (6) ensures each dekad is assigned to at most one phase. $D$ is a helper variable we use to ensure that the phases are continuous. Let $a_t$ be the $t^{th}$ row of $A$, this vector will have a $i=1$ if dekad $i$ is in phase $t$. We set $D_{t,d} = |A_{t,d+1}-A_{t,d}|$. Intuitively, $D$ keeps tracks of the number of times $a_t$ switches from 1 to 0 or vice versa. In order for a phase to be continuous, it can switch at most 2 times. The only non-continuous sequences that satisfy this are sequences starting and ending with ones, and having zeros in the middle: $(1,1,0,...,0,1,1)$. We exclude these sequences with constraint (9). Constraints 11-13 ensure that the start of phase $i+1$ is after the start of phase $i$. Intuitively, let $i^*$ be the first $i$ such that $A_{t,i} = 1$. We want $\alpha^t_j = 0$ for all $j < i^*$ and $\alpha^t_k = 1$ for all $k \geq i^*$. Constraint (12) ensures that $\alpha^t_i = 1$ only if $A_{t,i}=1$ or if $\alpha^t_{i-1} = 1$. The constraint that $A_{t,d} \leq \alpha^{t-1}_d - A_{t-1,d}$ ensures that phase $t+1$ starts after phase $t$ has ended. 

    \begin{align*}
        \alpha^1 &= (0,0,1,1,1,1,1,1,1,1)\\
        a^1 &=      (0,0,1,1,1,0,0,0,0,0)\\
        \alpha^2 &= (0,0,0,0,0,1,1,1,1,1)\\
        a^2 &=      (0,0,0,0,0,1,1,1,0,0)\\
        \alpha^3 &= (0,0,0,0,0,0,0,0,1,1)\\
        a^3 &=      (0,0,0,0,0,0,0,0,1,1)\\
    \end{align*}

    \begin{align*}
        \alpha^1 &= (1,1,1,1,1,1,1,1,1,1)\\
        a^1 &=      (1,1,1,0,0,0,0,0,0,0)\\
        \alpha^2 &= (0,0,0,0,1,1,1,1,1,1)\\
        a^2 &=      (0,0,0,0,1,1,1,1,0,0)\\
        \alpha^3 &= (0,0,0,0,0,0,0,0,1,1)\\
        a^3 &=      (0,0,0,0,0,0,0,0,1,1)\\
    \end{align*}
  
\end{document}